# escape=`

# This file is auto-generated by PostSharp.Engineering.

FROM mcr.microsoft.com/windows/servercore:ltsc2025

# The initial shell is Windows PowerShell (use full path to avoid HCS issues)
SHELL ["C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe", "-Command"]

# Prepare environment
ENV PSExecutionPolicyPreference=Bypass
ENV POWERSHELL_UPDATECHECK=Off
ENV TEMP=C:\Temp
ENV TMP=C:\Temp
ENV RUNNING_IN_DOCKER=TRUE

# Add Windows PowerShell to PATH (pwsh added later by PowershellComponent)
ENV PATH="C:\Windows\System32\WindowsPowerShell\v1.0;${PATH}"

# Enable long path support
RUN Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem' -Name 'LongPathsEnabled' -Value 1



# Install Git
RUN Invoke-WebRequest -Uri https://github.com/git-for-windows/git/releases/download/v2.50.0.windows.1/PortableGit-2.50.0-64-bit.7z.exe -OutFile PortableGit.exe; `
    Start-Process -FilePath .\PortableGit.exe -ArgumentList '-o"C:\git"', '-y' -Wait; `
    Remove-Item PortableGit.exe

# Add git to PATH using ENV directive (persists across shell switches)
ENV PATH="C:\git\cmd;C:\git\bin;C:\git\usr\bin;${PATH}"

RUN git config --system core.longpaths true

# Set CLAUDE_CODE_GIT_BASH_PATH for Claude Code
ENV CLAUDE_CODE_GIT_BASH_PATH=C:\git\bin\bash.exe


# Install PowerShell 7
RUN Invoke-WebRequest -Uri https://github.com/PowerShell/PowerShell/releases/download/v7.5.2/PowerShell-7.5.2-win-x64.msi -OutFile PowerShell.msi; `
    $process = Start-Process msiexec.exe -Wait -PassThru -ArgumentList '/I PowerShell.msi /quiet'; `
    if ($process.ExitCode -ne 0) { exit $process.ExitCode }; `
    Remove-Item PowerShell.msi

ENV PATH="C:\Program Files\PowerShell\7;${PATH}"


# Download .NET Installer
RUN Invoke-WebRequest -Uri https://dot.net/v1/dotnet-install.ps1 -OutFile dotnet-install.ps1

# Add .NET to PATH using ENV directive (persists across shell switches)
ENV PATH="C:\Program Files\dotnet;${PATH}"


# Install .NET Sdk 10.0.100
RUN & .\dotnet-install.ps1 -Version 10.0.100 -InstallDir 'C:\Program Files\dotnet'


# Install Node.js
RUN Invoke-WebRequest -Uri "https://nodejs.org/dist/v22.0.0/node-v22.0.0-win-x64.zip" -OutFile node.zip; `
    Expand-Archive node.zip -DestinationPath C:\; `
    Rename-Item "C:\node-v22.0.0-win-x64" "C:\nodejs"; `
    Remove-Item node.zip

ENV PATH="C:\nodejs;${PATH}"


# Install GitHub CLI
RUN Invoke-WebRequest -Uri https://github.com/cli/cli/releases/download/v2.63.2/gh_2.63.2_windows_amd64.msi -OutFile gh.msi; `
    $process = Start-Process msiexec.exe -Wait -PassThru -ArgumentList '/I gh.msi /quiet'; `
    if ($process.ExitCode -ne 0) { exit $process.ExitCode }; `
    Remove-Item gh.msi

ENV PATH="C:\Program Files\GitHub CLI;${PATH}"


# Install Claude CLI
# Configure npm global directory to avoid Windows container path issues
ENV NPM_CONFIG_PREFIX=C:\\npm
ENV PATH="C:\\npm;${PATH}"

# Install Claude CLI using cmd shell to avoid HCS issues with PowerShell
SHELL ["cmd", "/S", "/C"]
RUN C:\\nodejs\\npm.cmd install --global @anthropic-ai/claude-code

# Set HOME/USERPROFILE so Claude CLI finds credentials during build
ENV HOME=C:\\Users\\ContainerUser
ENV USERPROFILE=C:\\Users\\ContainerUser
ENV CLAUDE_CODE_SHELL=pwsh

# Create Claude config directory (credentials are mounted at runtime)
RUN mkdir C:\Users\ContainerUser\.claude

# Restore PowerShell shell using full path
SHELL ["C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe", "-Command"]


# Epilogue
# Create directories for mountpoints
ARG MOUNTPOINTS
RUN if ($env:MOUNTPOINTS) { `
        $mounts = $env:MOUNTPOINTS -split ';'; `
        foreach ($dir in $mounts) { `
            if ($dir) { `
                Write-Host "Creating directory $dir`."; `
                New-Item -ItemType Directory -Path $dir -Force | Out-Null; `
            } `
        } `
    }

# Import environment variables
COPY ReadEnvironmentVariables.ps1 c:\ReadEnvironmentVariables.ps1
COPY env.g.json c:\env.g.json
RUN c:\ReadEnvironmentVariables.ps1 c:\env.g.json

# Copy Init.g.ps1 placeholder (drive mappings handled inline in docker run)
COPY Init.g.ps1 c:\Init.g.ps1

# Configure .NET SDK
ENV DOTNET_NOLOGO=1
